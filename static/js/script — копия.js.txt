// static/js/script.js

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let chat = null;
let suggestions = null;
let modal = null;
let calculatorOpen = false;
let calculatorHistory = [];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    init();
    loadMenu();
    loadContextSuggestions();
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
function init() {
    chat = document.getElementById('chat');
    suggestions = document.getElementById('suggestions');
    modal = document.getElementById('calcModal');
    
    if (!chat || !suggestions) {
        console.error("‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã 'chat' –∏–ª–∏ 'suggestions' –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!");
        return;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    addMessage('assistant', `**${getGreeting()}!**\n\n–Ø –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫ –≤ D-Space. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    document.getElementById('send-btn').addEventListener('click', sendQuestion);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter
    document.getElementById('user-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendQuestion();
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
    initCalculator();
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å"
    document.getElementById('booking-btn').addEventListener('click', goToBooking);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é
function loadMenu() {
    fetch('/menu-items')
        .then(response => response.json())
        .then(data => {
            const suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = '';
            
            data.items.forEach(item => {
                const button = document.createElement('button');
                button.textContent = item.text;
                button.onclick = function() {
                    document.getElementById('user-input').value = item.question;
                    sendQuestion();
                };
                suggestionsDiv.appendChild(button);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä)
            const bookingBtn = document.createElement('button');
            bookingBtn.textContent = 'üìÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å';
            bookingBtn.style.background = '#ffc107';
            bookingBtn.style.color = '#212529';
            bookingBtn.onclick = goToBooking;
            suggestionsDiv.appendChild(bookingBtn);
            
            const calcBtn = document.createElement('button');
            calcBtn.textContent = 'üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä';
            calcBtn.className = 'btn-calc';
            calcBtn.onclick = openCalculator;
            suggestionsDiv.appendChild(calcBtn);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é:', error);
            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–µ–Ω—é –∫–∞–∫ fallback
            document.getElementById('suggestions').style.display = 'flex';
        });
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–∞
function sendQuestion() {
    const input = document.getElementById('user-input');
    const question = input.value.trim();
    
    if (!question) return;
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage('user', question);
    input.value = '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingMsg = addMessage('assistant', '...');
    loadingMsg.id = 'loading-message';
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch('/ask', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ question: question })
    })
    .then(response => response.json())
    .then(data => {
        // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const loadingMsg = document.getElementById('loading-message');
        if (loadingMsg) loadingMsg.remove();
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—Ç–≤–µ—Ç
        if (data.answer) {
            const formattedAnswer = formatAnswer(data.answer);
            const answerMsg = addMessage('assistant', formattedAnswer);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
            setTimeout(() => {
                showContextSuggestions(question, data.answer);
            }, 100);
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        const loadingMsg = document.getElementById('loading-message');
        if (loadingMsg) loadingMsg.remove();
        addMessage('assistant', '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    });
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
function addMessage(role, content) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    
    if (role === 'user') {
        messageDiv.innerHTML = `<div class="avatar">üë§</div><div class="content">${escapeHtml(content)}</div>`;
    } else {
        messageDiv.innerHTML = `<div class="avatar">ü§ñ</div><div class="content">${content}</div>`;
    }
    
    chat.appendChild(messageDiv);
    chat.scrollTop = chat.scrollHeight;
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ markdown –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    if (role === 'assistant') {
        const contentDiv = messageDiv.querySelector('.content');
        if (contentDiv) {
            contentDiv.innerHTML = marked.parse(contentDiv.textContent || '');
        }
    }
    
    return messageDiv;
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
function formatAnswer(answer) {
    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ç–∫—É –¥–ª—è —ç–º–æ–¥–∑–∏ –∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    return answer
        .replace(/üéÆ/g, '<span class="emoji">üéÆ</span>')
        .replace(/üéØ/g, '<span class="emoji">üéØ</span>')
        .replace(/üéâ/g, '<span class="emoji">üéâ</span>')
        .replace(/üìÖ/g, '<span class="emoji">üìÖ</span>')
        .replace(/üßÆ/g, '<span class="emoji">üßÆ</span>')
        .replace(/**/g, '<strong>')
        .replace(/\*\*/g, '</strong>');
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
function getGreeting() {
    const hour = new Date().getHours();
    if (hour < 12) return '–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ';
    if (hour < 18) return '–î–æ–±—Ä—ã–π –¥–µ–Ω—å';
    return '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä';
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫
function loadContextSuggestions() {
    // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∏–∑ –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
}

// –ü–æ–∫–∞–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫
function showContextSuggestions(question, answer) {
    const topic = getTopicFromQuestion(question);
    
    fetch('/suggestions')
        .then(response => response.json())
        .then(data => {
            if (data[topic]) {
                const fragment = document.createDocumentFragment();
                
                data[topic].forEach(btn => {
                    const b = document.createElement('button');
                    b.textContent = btn.text;
                    b.className = 'context-suggestion';
                    b.onclick = () => {
                        document.getElementById('user-input').value = btn.question;
                        sendQuestion();
                    };
                    fragment.appendChild(b);
                });
                
                const contextDiv = document.createElement('div');
                contextDiv.className = 'context-suggestions';
                contextDiv.appendChild(fragment);
                chat.appendChild(contextDiv);
                contextDiv.style.display = 'flex';
                
                // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–æ –∫–æ–Ω—Ü–∞ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫
                chat.scrollTop = chat.scrollHeight;
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥—Å–∫–∞–∑–æ–∫:', error);
        });
}

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–º—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–ø—Ä–æ—Å–∞
function getTopicFromQuestion(question) {
    const q = question.toLowerCase();
    if (q.includes('vr') || q.includes('–≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å')) return 'vr';
    if (q.includes('–±–∞—Ç—É—Ç') || q.includes('–ø—Ä—ã–∂–∫–∏')) return 'batuts';
    if (q.includes('–Ω–µ—Ä—Ñ') || q.includes('–ª–∞–∑–µ—Ä')) return 'nerf';
    if (q.includes('–¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è') || q.includes('–¥—Ä') || q.includes('–¥—Ä.')) return 'birthday';
    if (q.includes('–≤—ã–ø—É—Å–∫–Ω–æ–π') || q.includes('–æ–∫–æ–Ω—á–∞–Ω–∏–µ —à–∫–æ–ª—ã')) return 'graduation';
    if (q.includes('–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ') || q.includes('—Å–æ–±—ã—Ç–∏–µ') || q.includes('–∞–∫—Ü–∏—è')) return 'events';
    if (q.includes('–æ—Ä–±–∏–∑') || q.includes('–æ—Ä–±–∏')) return 'orbiz';
    if (q.includes('–ª–∞–∑–µ—Ä—Ç–∞–≥') || q.includes('–ª–∞–∑–µ—Ä–Ω—ã–π')) return 'lazertag';
    return 'default';
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
function goToBooking() {
    window.location.href = '/booking';
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
function initCalculator() {
    const calcModal = document.getElementById('calcModal');
    
    if (calcModal) {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
        document.querySelectorAll('#calculator-buttons button').forEach(button => {
            button.addEventListener('click', () => {
                const value = button.getAttribute('data-value');
                if (value) {
                    handleCalculatorInput(value);
                }
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
        document.querySelector('#calcModal .close').addEventListener('click', () => {
            calculatorOpen = false;
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        window.addEventListener('click', (event) => {
            if (event.target === calcModal) {
                calculatorOpen = false;
                calcModal.style.display = 'none';
            }
        });
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ
function handleCalculatorInput(value) {
    const display = document.getElementById('calculator-display');
    let currentValue = display.textContent;
    
    if (value === 'C') {
        display.textContent = '0';
        calculatorHistory = [];
        return;
    }
    
    if (value === '‚Üê') {
        if (currentValue.length > 1) {
            display.textContent = currentValue.slice(0, -1);
        } else {
            display.textContent = '0';
        }
        return;
    }
    
    if (value === '=') {
        try {
            const result = eval(currentValue);
            calculatorHistory.push(`${currentValue} = ${result}`);
            display.textContent = result;
            saveCalculatorHistory();
        } catch (e) {
            display.textContent = '–û—à–∏–±–∫–∞';
        }
        return;
    }
    
    if (currentValue === '0' && !['+', '-', '*', '/'].includes(value)) {
        display.textContent = value;
    } else {
        display.textContent = currentValue + value;
    }
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
function openCalculator() {
    calculatorOpen = true;
    document.getElementById('calcModal').style.display = 'block';
    loadCalculatorHistory();
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
function saveCalculatorHistory() {
    localStorage.setItem('calculatorHistory', JSON.stringify(calculatorHistory));
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
function loadCalculatorHistory() {
    const history = localStorage.getItem('calculatorHistory');
    if (history) {
        calculatorHistory = JSON.parse(history);
        const historyDiv = document.getElementById('calculator-history');
        historyDiv.innerHTML = '';
        
        calculatorHistory.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'history-item';
            itemDiv.textContent = item;
            historyDiv.appendChild(itemDiv);
        });
    }
}

// –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "<")
        .replace(/>/g, ">")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// –û—Ü–µ–Ω–∫–∞ –æ—Ç–≤–µ—Ç–∞
function rate(question, feedback) {
    const buttons = document.querySelectorAll('.feedback button');
    buttons.forEach(b => {
        b.disabled = true;
        b.style.opacity = "0.5";
        b.style.cursor = "not-allowed";
    });
    
    fetch('/feedback', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            question: question,
            feedback: feedback
        })
    }).then(response => {
        if (response.ok) {
            const status = document.createElement('div');
            status.className = 'feedback-status';
            status.textContent = feedback === 1 ? '–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É!' : '–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤!';
            status.style.marginTop = '10px';
            status.style.color = feedback === 1 ? 'green' : 'red';
            document.querySelector('.feedback').appendChild(status);
            
            setTimeout(() => {
                status.remove();
            }, 3000);
        }
    });
}
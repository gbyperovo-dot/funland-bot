<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>D-Space ‚Äî –†–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä</title>
    <link rel="stylesheet" href="/static/style.css">
    <!-- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —É–±—Ä–∞–Ω –ø—Ä–æ–±–µ–ª –≤ URL -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* –£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ */
        .chat-box {
            height: 500px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            width: 100%;
            max-width: 95vw;
            margin: 0 auto;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ ‚Äî —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º –∏ —Å—Ç–∏–ª—è–º–∏ */
        .context-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 5px 0 10px;
            padding: 0;
        }
        .context-suggestions button {
            font-size: 0.85rem;
            padding: 6px 10px;
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
        }
        .context-suggestions button:hover {
            background: #0d6efd;
            color: white;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –æ—Ü–µ–Ω–∫–∏ */
        .feedback {
            margin: 5px 0;
            font-size: 0.9em;
            color: #6c757d;
        }
        .feedback button {
            padding: 2px 6px;
            font-size: 0.8rem;
            margin: 0 2px;
            border: none;
            background: none;
            cursor: pointer;
        }
        .feedback button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ */
        .text-center {
            text-align: center;
        }
        .spinner-border {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            vertical-align: text-bottom;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        .alert {
            position: relative;
            padding: 0.75rem 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 0.25rem;
        }
        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeeba;
        }
        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéâ D-Space‚Äî –≤–∞—à —Ü–µ–Ω—Ç—Ä –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è –∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞</h1>
        <div id="chat" class="chat-box"></div>

        <div class="input-area">
            <input type="text" id="user-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫—É..." autofocus>
            <button onclick="sendQuestion()">üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button onclick="clearChat()" class="btn-clear">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –º–µ–Ω—é -->
        <div id="menuButtons" class="suggestions">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é...</span>
                </div>
                <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é...</p>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ -->
    <div id="calcModal" class="modal">
        <div class="modal-content">
            <h2>üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏</h2>
            <span class="close" onclick="closeCalculator()">&times;</span>
            <form id="calcForm">
                <label>–£—Å–ª—É–≥–∞:
                    <select id="service" onchange="updateForm()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                        <option value="birthday">üéâ –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</option>
                        <option value="graduation">üéì –í—ã–ø—É—Å–∫–Ω–æ–π</option>
                        <option value="outdoor">üöê –í—ã–µ–∑–¥–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</option>
                    </select>
                </label>
                <div id="dynamicForm"></div>
                <div class="result" id="result"></div>
                <button type="button" onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
            </form>
        </div>
    </div>

    <!-- –°—Å—ã–ª–∫–∏ –≤–Ω–∏–∑—É -->
    <p style="text-align: center; margin-top: 15px; font-size: 14px; color: #6c757d;">
        <a href="/admin/login" style="color: #dc3545; margin: 0 10px;">üîê –ê–¥–º–∏–Ω–∫–∞</a>
    </p>

    <script>
        let chat = null;
        let lastQuestion = '';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            chat = document.getElementById('chat');

            if (!chat) {
                console.error("‚ùå –≠–ª–µ–º–µ–Ω—Ç 'chat' –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                return;
            }

            addMessage('assistant', `**${getGreeting()}!**\n\n–†–∞–¥—ã –≤–∞—Å –≤–∏–¥–µ—Ç—å –≤ **D-Space**! üé™\n\n–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –º–µ–Ω—é
            loadMenu();

            window.addEventListener("message", function(event) {
                if (event.data.type === "birthday_calc") {
                    addMessage("assistant", `üßÆ –†–∞—Å—Å—á–∏—Ç–∞–Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–Ω—è —Ä–æ–∂–¥–µ–Ω–∏—è: **${event.data.amount} ‚ÇΩ**\n\n–•–æ—Ç–∏—Ç–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å? –ù–∞–ø–∏—à–∏—Ç–µ: *¬´—Ö–æ—á—É –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å¬ª*`);
                }
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –º–µ–Ω—é
        async function loadMenu() {
            try {
                const response = await fetch('/menu-items');
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é');
                }
                
                const data = await response.json();
                renderMenu(data.items);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é:', error);
                document.getElementById('menuButtons').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ–Ω—é
                    </div>
                `;
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–µ–Ω—é
        function renderMenu(menuItems) {
            const menuContainer = document.getElementById('menuButtons');
            
            if (!menuItems || menuItems.length === 0) {
                menuContainer.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> –ú–µ–Ω—é –ø—É—Å—Ç–æ–µ
                    </div>
                `;
                return;
            }
            
            let menuHTML = '';
            
            menuItems.forEach(item => {
                menuHTML += `
                    <button class="btn btn-primary menu-btn m-2" onclick="ask('${item.question}')">
                        ${item.display_text}
                    </button>
                `;
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–Ω–æ–ø–∫–∏
            menuHTML += `
                <button onclick="goToBooking()" style="background: #ffc107; color: #212529;">üìÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                <button onclick="openCalculator()" class="btn-calc">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
            `;
            
            menuContainer.innerHTML = menuHTML;
            menuContainer.style.display = "flex";
        }

        // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        function getGreeting() {
            const h = new Date().getHours();
            return h < 6 ? "–î–æ–±—Ä–æ–π –Ω–æ—á–∏" : h < 12 ? "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ" : h < 18 ? "–î–æ–±—Ä—ã–π –¥–µ–Ω—å" : "–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä";
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function addMessage(role, text) {
            if (!chat) {
                console.error("‚ùå –≠–ª–µ–º–µ–Ω—Ç 'chat' –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                return;
            }

            const msg = document.createElement('div');
            msg.className = `message ${role}`;
            msg.innerHTML = marked.parse(text);
            chat.appendChild(msg);

            // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –æ—Ü–µ–Ω–∫—É –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞
            if (role === "assistant") {
                const feedback = document.createElement('div');
                feedback.className = "feedback";
                feedback.innerHTML = `
                    –ë—ã–ª –ª–∏ –æ—Ç–≤–µ—Ç –ø–æ–ª–µ–∑–µ–Ω? 
                    <button onclick="rate('${lastQuestion}', 'good')">üëç</button>
                    <button onclick="rate('${lastQuestion}', 'bad')">üëé</button>
                `;
                chat.appendChild(feedback);
            }

            chat.scrollTop = chat.scrollHeight;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–∞
        function sendQuestion() {
            const input = document.getElementById('user-input');
            const question = input.value.trim();
            if (!question) return;

            lastQuestion = question;
            addMessage('user', question);
            input.value = '';

            fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    question: question,
                    user_id: "user_" + (Date.now() % 10000)
                })
            })
            .then(r => r.json())
            .then(data => {
                addMessage('assistant', data.answer);
                showSuggestionsForAnswer(data.answer);
            })
            .catch(err => {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", err);
                addMessage('assistant', 'üö´ –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            });
        }

        // –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—Ä–æ—Å
        function ask(topic) {
            document.getElementById('user-input').value = topic;
            sendQuestion();
        }

        // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        function goToBooking() {
            window.location.href = '/booking';
        }

        // === –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ ===
        const suggestionMap = {
            "–Ω–µ—Ä—Ñ": [
                { text: "–ü—Ä–∞–≤–∏–ª–∞", question: "–ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ –Ω–µ—Ä—Ñ–µ" },
                { text: "–¶–µ–Ω—ã", question: "—Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–µ—Ä—Ñ-–∞—Ä–µ–Ω—ã" },
                { text: "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å", question: "—Ö–æ—á—É –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Ä—Ñ" }
            ],
            "–±–∞—Ç—É—Ç—ã": [
                { text: "–î–ª—è –¥–µ—Ç–µ–π?", question: "–º–æ–∂–Ω–æ –ª–∏ –Ω–∞ –±–∞—Ç—É—Ç—ã —Å –º–∞–ª–µ–Ω—å–∫–∏–º–∏ –¥–µ—Ç—å–º–∏" },
                { text: "–¶–µ–Ω—ã", question: "—Å—Ç–æ–∏–º–æ—Å—Ç—å –±–∞—Ç—É—Ç–æ–≤" },
                { text: "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å", question: "–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –±–∞—Ç—É—Ç—ã" }
            ],
            "–¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è": [
                { text: "–ü–∞–∫–µ—Ç—ã", question: "–ø–∞–∫–µ—Ç—ã –Ω–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è" },
                { text: "–¶–µ–Ω—ã", question: "—Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–Ω—è —Ä–æ–∂–¥–µ–Ω–∏—è" },
                { text: "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å", question: "—Ö–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è" }
            ],
            "vr": [
                { text: "–ò–≥—Ä—ã", question: "–∏–≥—Ä—ã –≤ vr" },
                { text: "–¶–µ–Ω—ã", question: "—Å—Ç–æ–∏–º–æ—Å—Ç—å vr" },
                { text: "–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å", question: "–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å vr" },
                { text: "–ü—Ä–∞–≤–∏–ª–∞", question: "–ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ vr" }
            ]
        };

        function detectTopic(answer) {
            const topics = Object.keys(suggestionMap);
            const lowerAnswer = answer.toLowerCase();
            for (let topic of topics) {
                if (lowerAnswer.includes(topic)) {
                    return topic;
                }
            }
            return null;
        }

        function showSuggestionsForAnswer(answer) {
            const topic = detectTopic(answer);
            if (topic && suggestionMap[topic]) {
                const fragment = document.createDocumentFragment();
                suggestionMap[topic].forEach(btn => {
                    const b = document.createElement("button");
                    b.textContent = btn.text;
                    b.onclick = () => {
                        document.getElementById("user-input").value = btn.question;
                        sendQuestion();
                    };
                    fragment.appendChild(b);
                });

                const contextDiv = document.createElement("div");
                contextDiv.className = "context-suggestions";
                contextDiv.appendChild(fragment);
                chat.appendChild(contextDiv);
                contextDiv.style.display = "flex";

                // ‚úÖ –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–æ –∫–æ–Ω—Ü–∞ –ü–û–°–õ–ï –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫
                chat.scrollTop = chat.scrollHeight;
            }
        }

        // === –û—Ü–µ–Ω–∫–∞ –æ—Ç–≤–µ—Ç–∞ ===
        function rate(question, feedback) {
            const buttons = document.querySelectorAll('.feedback button');
            buttons.forEach(b => {
                b.disabled = true;
                b.style.opacity = "0.5";
                b.style.cursor = "not-allowed";
            });

            fetch('/feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question, feedback })
            }).catch(err => {
                console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ü–µ–Ω–∫–∏:", err);
            });
        }

        // === –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä ===
        function openCalculator() { 
            document.getElementById('calcModal').style.display = "block"; 
        }
        function closeCalculator() { 
            document.getElementById('calcModal').style.display = "none"; 
        }

        function updateForm() {
            const service = document.getElementById("service").value;
            const df = document.getElementById("dynamicForm");
            df.innerHTML = "";

            if (service === "birthday") {
                df.innerHTML = `
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π:
                        <input type="number" id="guests" min="5" max="30" value="10">
                    </label>
                    <label>–ü–∞–∫–µ—Ç:
                        <select id="package">
                            <option value="standard">–°—Ç–∞–Ω–¥–∞—Ä—Ç (8000 ‚ÇΩ)</option>
                            <option value="extreme">–≠–∫—Å—Ç—Ä–∏–º (12 000 ‚ÇΩ)</option>
                            <option value="vr">VR-–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ (15 000 ‚ÇΩ)</option>
                        </select>
                    </label>
                    <label><input type="checkbox" id="anim"> –ê–Ω–∏–º–∞—Ç–æ—Ä (+3000 ‚ÇΩ)</label>
                    <label><input type="checkbox" id="cake"> –§–æ—Ç–æ—Å–µ—Å—Å–∏—è (+2000 ‚ÇΩ)</label>
                    <label><input type="checkbox" id="tort"> –¢–æ—Ä—Ç (+1500 ‚ÇΩ)</label>
                `;
            }
        }

        function calculate() {
            const pkg = document.getElementById("package").value;
            const guests = parseInt(document.getElementById("guests").value) || 10;
            const anim = document.getElementById("anim").checked;
            const cake = document.getElementById("cake").checked;
            const tort = document.getElementById("tort").checked;

            const base = { standard: 8000, extreme: 12000, vr: 15000 }[pkg];
            let total = base + Math.max(0, (guests - 10)) * 200;
            if (anim) total += 3000;
            if (cake) total += 2000;
            if (tort) total += 1500;

            document.getElementById("result").innerHTML = `
                <strong>–ò—Ç–æ–≥–æ: ${total} ‚ÇΩ</strong>
                <button onclick="sendCalcResult(${total})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç</button>
            `;
        }

        function sendCalcResult(amount) {
            addMessage('assistant', `üßÆ –†–∞—Å—Å—á–∏—Ç–∞–Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å: **${amount} ‚ÇΩ**`);
            closeCalculator();
        }

        function clearChat() {
            if (!chat) return;
            chat.innerHTML = "";
            addMessage('assistant', `**${getGreeting()}!**\n\n–†–∞–¥—ã –≤–∞—Å –≤–∏–¥–µ—Ç—å –≤ **D-Space**! üé™`);
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é
            loadMenu();
        }

        // === –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ===
        window.onload = init;

        // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(loadMenu, 30000);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ–Ω—é –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                loadMenu();
            }
        });
    </script>
</body>
</html>
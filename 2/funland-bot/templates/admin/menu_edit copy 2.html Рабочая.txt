<!-- templates/admin/menu_edit.html -->
{% extends "admin/base.html" %}

{% block content %}
<div class="container-fluid">
    <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é</h2>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–Ω–æ–ø–∫—É</h5>
                </div>
                <div class="card-body">
                    <form id="addMenuForm">
                        <div class="mb-3">
                            <label for="admin_text" class="form-label">–¢–µ–∫—Å—Ç –≤ –∞–¥–º–∏–Ω–∫–µ:</label>
                            <input type="text" class="form-control" id="admin_text" name="admin_text" required>
                            <div class="form-text">–ù–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –∞–¥–º–∏–Ω–∫–µ</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="display_text" class="form-label">–¢–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ:</label>
                            <input type="text" class="form-control" id="display_text" name="display_text" required>
                            <div class="form-text">–¢–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π —É–≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: "VR-–∑–æ–Ω—ã ‚Äî –æ—Ç 300 ‚ÇΩ")</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="question" class="form-label">–í–æ–ø—Ä–æ—Å –¥–ª—è –±–æ—Ç–∞:</label>
                            <input type="text" class="form-control" id="question" name="question" required>
                            <div class="form-text">–í–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –±–æ—Ç—É –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="category" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                {% if categories.system_categories %}
                                    {% for category_key, category_name in categories.system_categories.items() %}
                                    <option value="{{ category_key }}">{{ category_name }}</option>
                                    {% endfor %}
                                {% endif %}
                                {% if categories.custom_categories %}
                                    {% for category_key, category_name in categories.custom_categories.items() %}
                                    <option value="{{ category_key }}">{{ category_name }}</option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                            <div class="form-text">
                                <a href="/admin/menu/categories" target="_blank">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</a>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="price_info" class="form-label">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ü–µ–Ω–µ:</label>
                            <input type="text" class="form-control" id="price_info" name="price_info" placeholder="–æ—Ç 300 ‚ÇΩ">
                            <div class="form-text">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ü–µ–Ω–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
                        </button>
                        
                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="loadCategories()">
                            <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é</h5>
                    <span class="badge bg-primary">{{ menu_items|length }} –∫–Ω–æ–ø–æ–∫</span>
                </div>
                <div class="card-body">
                    {% if menu_items %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>–¢–µ–∫—Å—Ç –≤ –∞–¥–º–∏–Ω–∫–µ</th>
                                    <th>–¢–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ</th>
                                    <th>–í–æ–ø—Ä–æ—Å</th>
                                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in menu_items %}
                                <tr>
                                    <td>{{ item.admin_text }}</td>
                                    <td>{{ item.display_text }}</td>
                                    <td><code>{{ item.question }}</code></td>
                                    <td>
                                        <span class="badge bg-secondary">
                                            {% if categories.system_categories and item.category in categories.system_categories %}
                                                {{ categories.system_categories[item.category] }}
                                            {% elif categories.custom_categories and item.category in categories.custom_categories %}
                                                {{ categories.custom_categories[item.category] }}
                                            {% else %}
                                                {{ item.category }}
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick="editMenuItem({{ loop.index0 }})">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteMenuItem({{ loop.index0 }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> –ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∫–Ω–æ–ø–∫—É –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º—É —Å–ª–µ–≤–∞.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editMenuForm">
                    <input type="hidden" id="edit_index" name="index">
                    <div class="mb-3">
                        <label for="edit_admin_text" class="form-label">–¢–µ–∫—Å—Ç –≤ –∞–¥–º–∏–Ω–∫–µ:</label>
                        <input type="text" class="form-control" id="edit_admin_text" name="admin_text" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_display_text" class="form-label">–¢–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ:</label>
                        <input type="text" class="form-control" id="edit_display_text" name="display_text" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_question" class="form-label">–í–æ–ø—Ä–æ—Å –¥–ª—è –±–æ—Ç–∞:</label>
                        <input type="text" class="form-control" id="edit_question" name="question" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_category" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                        <select class="form-select" id="edit_category" name="category" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            {% if categories.system_categories %}
                                {% for category_key, category_name in categories.system_categories.items() %}
                                <option value="{{ category_key }}">{{ category_name }}</option>
                                {% endfor %}
                            {% endif %}
                            {% if categories.custom_categories %}
                                {% for category_key, category_name in categories.custom_categories.items() %}
                                <option value="{{ category_key }}">{{ category_name }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_price_info" class="form-label">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ü–µ–Ω–µ:</label>
                        <input type="text" class="form-control" id="edit_price_info" name="price_info">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">
                    <i class="bi bi-check-circle"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–Ω–æ–ø–∫—É –º–µ–Ω—é?</p>
                <p id="deleteItemInfo" class="text-danger fw-bold"></p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
let currentDeleteIndex = null;
let categoriesData = {
    system_categories: {
        {% for key, name in categories.system_categories.items() %}
        "{{ key }}": "{{ name }}"{% if not loop.last %},{% endif %}
        {% endfor %}
    },
    custom_categories: {
        {% for key, name in categories.custom_categories.items() %}
        "{{ key }}": "{{ name }}"{% if not loop.last %},{% endif %}
        {% endfor %}
    }
};

// üîÑ –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
async function loadCategories() {
    try {
        showNotification('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...', 'info');
        
        const response = await fetch('/admin/menu/categories/data');
        if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π');
        }
        
        categoriesData = await response.json();
        updateCategoryDropdowns(categoriesData);
        showNotification('–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
        showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π', 'error');
    }
}

// üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ dropdown-–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
function updateCategoryDropdowns(categories) {
    const dropdowns = [
        document.getElementById('category'),
        document.getElementById('edit_category')
    ];
    
    dropdowns.forEach(dropdown => {
        if (dropdown) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            const currentValue = dropdown.value;
            
            // –û—á–∏—â–∞–µ–º options (–∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ)
            const optionsToKeep = [dropdown.options[0]];
            for (let i = dropdown.options.length - 1; i >= 1; i--) {
                dropdown.remove(i);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if (categories.system_categories) {
                for (const [key, name] of Object.entries(categories.system_categories)) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = name;
                    dropdown.appendChild(option);
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            if (categories.custom_categories) {
                for (const [key, name] of Object.entries(categories.custom_categories)) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = name;
                    dropdown.appendChild(option);
                }
            }
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
            if (currentValue) {
                const optionExists = Array.from(dropdown.options).some(opt => opt.value === currentValue);
                if (optionExists) {
                    dropdown.value = currentValue;
                }
            }
        }
    });
}

// üîÑ –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
async function getCategoriesData() {
    try {
        const response = await fetch('/admin/menu/categories/data');
        if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π');
        }
        return await response.json();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
        return categoriesData; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    }
}

// üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function validateCategory(categoryKey, categories) {
    return (categories.system_categories && categories.system_categories[categoryKey]) ||
           (categories.custom_categories && categories.custom_categories[categoryKey]);
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏
document.getElementById('addMenuForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> –î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
    
    try {
        const formData = new FormData(this);
        
        // üîÑ –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const categories = await getCategoriesData();
        const selectedCategory = formData.get('category');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
        if (!validateCategory(selectedCategory, categories)) {
            showNotification('–û—à–∏–±–∫–∞: –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
            return;
        }
        
        const response = await fetch('/admin/menu/add', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        if (result.success) {
            showNotification('–ö–Ω–æ–ø–∫–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + result.error, 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É';
    }
});

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
function editMenuItem(index) {
    const menuItems = {{ menu_items|tojson|safe }};
    const item = menuItems[index];
    
    document.getElementById('edit_index').value = index;
    document.getElementById('edit_admin_text').value = item.admin_text || '';
    document.getElementById('edit_display_text').value = item.display_text || '';
    document.getElementById('edit_question').value = item.question || '';
    document.getElementById('edit_category').value = item.category || '';
    document.getElementById('edit_price_info').value = item.price_info || '';
    
    // üîÑ –û–±–Ω–æ–≤–ª—è–µ–º dropdown –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º
    updateCategoryDropdowns(categoriesData);
    
    new bootstrap.Modal(document.getElementById('editModal')).show();
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
async function saveEdit() {
    const saveBtn = document.querySelector('#editModal .btn-primary');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    
    try {
        const formData = new FormData(document.getElementById('editMenuForm'));
        const index = formData.get('index');
        
        // üîÑ –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const categories = await getCategoriesData();
        const selectedCategory = formData.get('category');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        if (!validateCategory(selectedCategory, categories)) {
            showNotification('–û—à–∏–±–∫–∞: –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
            return;
        }
        
        const response = await fetch(`/admin/menu/edit/${index}`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        if (result.success) {
            showNotification('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
            document.getElementById('editModal').querySelector('.btn-close').click();
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + result.error, 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="bi bi-check-circle"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    }
}

// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —É–¥–∞–ª–µ–Ω–∏—é –∫–Ω–æ–ø–∫–∏
function deleteMenuItem(index) {
    const menuItems = {{ menu_items|tojson|safe }};
    const item = menuItems[index];
    
    currentDeleteIndex = index;
    document.getElementById('deleteItemInfo').textContent = 
        `${item.admin_text} ‚Üí ${item.question}`;
    
    new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
}

// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
async function confirmDelete() {
    const deleteBtn = document.querySelector('#deleteConfirmModal .btn-danger');
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> –£–¥–∞–ª–µ–Ω–∏–µ...';
    
    try {
        const response = await fetch(`/admin/menu/delete/${currentDeleteIndex}`);
        const result = await response.json();
        
        if (result.success) {
            showNotification('–ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞!', 'success');
            document.getElementById('deleteConfirmModal').querySelector('.btn-close').click();
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + result.error, 'error');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
    } finally {
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = '<i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å';
        currentDeleteIndex = null;
    }
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
document.getElementById('addMenuForm').addEventListener('input', function(e) {
    const questionInput = document.getElementById('question');
    if (e.target === questionInput) {
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º display_text –Ω–∞ –æ—Å–Ω–æ–≤–µ question
        const displayTextInput = document.getElementById('display_text');
        if (!displayTextInput.value && questionInput.value) {
            displayTextInput.value = questionInput.value;
        }
    }
});

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const oldNotifications = document.querySelectorAll('.alert-position');
    oldNotifications.forEach(el => el.remove());
    
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show alert-position`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1060;
        min-width: 300px;
        max-width: 400px;
    `;
    notification.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (notification.parentNode) {
            const bsAlert = new bootstrap.Alert(notification);
            bsAlert.close();
        }
    }, 5000);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', categoriesData);
    
    // üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(loadCategories, 30000);
    
    // üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            loadCategories();
        }
    });
    
    // üîÑ –ö–Ω–æ–ø–∫–∞ —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    const refreshBtn = document.querySelector('[onclick="loadCategories()"]');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', loadCategories);
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
    showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö', 'error');
});
</script>

<style>
.alert-position {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1060;
    min-width: 300px;
    max-width: 400px;
}

.menu-btn {
    transition: all 0.3s ease;
}

.menu-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.table th {
    background-color: #f8f9fa;
    border-top: none;
}

.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom: none;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

.badge {
    font-size: 0.75em;
}

code {
    background: #f8f9fa;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
}
</style>
{% endblock %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>D-Space ‚Äî –†–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä</title>
    <link rel="stylesheet" href="/static/style.css">
    <!-- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: —É–±—Ä–∞–Ω –ø—Ä–æ–±–µ–ª –≤ URL -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div class="container">
        <h1>üéâ D-Space‚Äî –≤–∞—à —Ü–µ–Ω—Ç—Ä –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è –∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞</h1>
        <div id="chat" class="chat-box"></div>

        <div class="input-area">
            <input type="text" id="user-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫—É..." autofocus>
            <button onclick="sendQuestion()">üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button onclick="clearChat()" class="btn-clear">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ -->
        <div id="suggestions" class="suggestions">
            <button onclick="ask('vr')">üéÆ VR-–∑–æ–Ω—ã</button>
            <button onclick="ask('–±–∞—Ç—É—Ç—ã')">üèÄ –ë–∞—Ç—É—Ç–Ω—ã–π —Ü–µ–Ω—Ç—Ä</button>
            <button onclick="ask('–Ω–µ—Ä—Ñ')">üî´ –ù–µ—Ä—Ñ-–∞—Ä–µ–Ω–∞</button>
            <button onclick="ask('–¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è')">üéâ –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</button>
            <button onclick="ask('–≤—ã–ø—É—Å–∫–Ω—ã–µ')">üéì –í—ã–ø—É—Å–∫–Ω—ã–µ</button>
            <button onclick="ask('–≤—ã–µ–∑–¥–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è')">üöê –í—ã–µ–∑–¥–Ω—ã–µ</button>
            <button onclick="ask('–∞–∫—Ü–∏–∏')">üéÅ –ê–∫—Ü–∏–∏</button>
            <button onclick="goToBooking()" style="background: #ffc107; color: #212529;">üìÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
            <button onclick="openCalculator()" class="btn-calc">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ -->
    <div id="calcModal" class="modal">
        <div class="modal-content">
            <h2>üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏</h2>
            <span class="close" onclick="closeCalculator()">&times;</span>
            <form id="calcForm">
                <label>–£—Å–ª—É–≥–∞:
                    <select id="service" onchange="updateForm()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                        <option value="birthday">üéâ –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</option>
                        <option value="graduation">üéì –í—ã–ø—É—Å–∫–Ω–æ–π</option>
                        <option value="outdoor">üöê –í—ã–µ–∑–¥–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</option>
                    </select>
                </label>
                <div id="dynamicForm"></div>
                <div class="result" id="result"></div>
                <!-- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å" -->
                <button type="button" onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
            </form>
        </div>
    </div>

    <!-- –°—Å—ã–ª–∫–∏ –≤–Ω–∏–∑—É -->
    <p style="text-align: center; margin-top: 15px; font-size: 14px; color: #6c757d;">
        
        <a href="/admin/login" style="color: #dc3545; margin: 0 10px;">üîê –ê–¥–º–∏–Ω–∫–∞</a>
    </p>

    <script>
        const chat = document.getElementById('chat');
        const suggestions = document.getElementById('suggestions');
        const modal = document.getElementById('calcModal');

        // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        function getGreeting() {
            const h = new Date().getHours();
            return h < 6 ? "–î–æ–±—Ä–æ–π –Ω–æ—á–∏" : h < 12 ? "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ" : h < 18 ? "–î–æ–±—Ä—ã–π –¥–µ–Ω—å" : "–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä";
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function addMessage(role, text) {
            const msg = document.createElement('div');
            msg.className = `message ${role}`;
            msg.innerHTML = marked.parse(text);
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤–æ–ø—Ä–æ—Å–∞
        function sendQuestion() {
            const input = document.getElementById('user-input');
            const question = input.value.trim();
            if (!question) return;

            addMessage('user', question);
            input.value = '';
            hideSuggestions();

            fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    question: question,
                    user_id: "user_" + (Date.now() % 10000)
                })
            })
            .then(r => r.json())
            .then(data => {
                addMessage('assistant', data.answer);
                suggestions.style.display = "flex";
            })
            .catch(err => {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", err);
                addMessage('assistant', 'üö´ –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
                suggestions.style.display = "flex";
            });
        }

        // –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—Ä–æ—Å
        function ask(topic) {
            document.getElementById('user-input').value = topic;
            sendQuestion();
        }

        // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        function goToBooking() {
            window.location.href = '/booking';
        }

        // –°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏
        function hideSuggestions() {
            suggestions.style.display = "none";
        }

        // === –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ===
        window.onload = () => {
            addMessage('assistant', `**${getGreeting()}!**\n\n–†–∞–¥—ã –≤–∞—Å –≤–∏–¥–µ—Ç—å –≤ **D-Space**! üé™\n\n–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`);
            suggestions.style.display = "flex";

            // ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –¥—Ä—É–≥–∏—Ö –æ–∫–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä)
            window.addEventListener("message", function(event) {
                if (event.data.type === "birthday_calc") {
                    addMessage("assistant", `üßÆ –†–∞—Å—Å—á–∏—Ç–∞–Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–Ω—è —Ä–æ–∂–¥–µ–Ω–∏—è: **${event.data.amount} ‚ÇΩ**\n\n–•–æ—Ç–∏—Ç–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å? –ù–∞–ø–∏—à–∏—Ç–µ: *¬´—Ö–æ—á—É –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å¬ª*`);
                }
            });
        };

        // === –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä ===
        function openCalculator() { 
            modal.style.display = "block"; 
        }
        function closeCalculator() { 
            modal.style.display = "none"; 
        }

        function updateForm() {
            const service = document.getElementById("service").value;
            const df = document.getElementById("dynamicForm");
            df.innerHTML = "";

            if (service === "birthday") {
                df.innerHTML = `
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π:
                        <input type="number" id="guests" min="5" max="30" value="10">
                    </label>
                    <label>–ü–∞–∫–µ—Ç:
                        <select id="package">
                            <option value="standard">–°—Ç–∞–Ω–¥–∞—Ä—Ç (8000 ‚ÇΩ)</option>
                            <option value="extreme">–≠–∫—Å—Ç—Ä–∏–º (12 000 ‚ÇΩ)</option>
                            <option value="vr">VR-–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ (15 000 ‚ÇΩ)</option>
                        </select>
                    </label>
                    <label><input type="checkbox" id="anim"> –ê–Ω–∏–º–∞—Ç–æ—Ä (+3000 ‚ÇΩ)</label>
                    <label><input type="checkbox" id="cake"> –§–æ—Ç–æ—Å–µ—Å—Å–∏—è (+2000 ‚ÇΩ)</label>
                    <label><input type="checkbox" id="tort"> –¢–æ—Ä—Ç (+1500 ‚ÇΩ)</label>
                `;
            }
        }

        function calculate() {
            const pkg = document.getElementById("package").value;
            const guests = parseInt(document.getElementById("guests").value) || 10;
            const anim = document.getElementById("anim").checked;
            const cake = document.getElementById("cake").checked;
            const tort = document.getElementById("tort").checked;

            const base = { standard: 8000, extreme: 12000, vr: 15000 }[pkg];
            let total = base + Math.max(0, (guests - 10)) * 200;
            if (anim) total += 3000;
            if (cake) total += 2000;
            if (tort) total += 1500;

            document.getElementById("result").innerHTML = `
                <strong>–ò—Ç–æ–≥–æ: ${total} ‚ÇΩ</strong>
                <button onclick="sendCalcResult(${total})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç</button>
            `;
        }

        function sendCalcResult(amount) {
            addMessage('assistant', `üßÆ –†–∞—Å—Å—á–∏—Ç–∞–Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å: **${amount} ‚ÇΩ**`);
            closeCalculator();
        }

        function clearChat() {
            chat.innerHTML = "";
            addMessage('assistant', `**${getGreeting()}!**\n\n–†–∞–¥—ã –≤–∞—Å –≤–∏–¥–µ—Ç—å –≤ **D-Space**! üé™`);
            suggestions.style.display = "flex";
        }
    </script>
</body>
</html>
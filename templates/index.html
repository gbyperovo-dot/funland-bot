<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>FunLand ‚Äî –†–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π —Ü–µ–Ω—Ç—Ä</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üéâ FunLand ‚Äî –≤–∞—à —Ü–µ–Ω—Ç—Ä –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è –∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ—Ç–¥—ã—Ö–∞</h1>
        <div id="chat" class="chat-box"></div>

        <div class="input-area">
            <input type="text" id="user-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫—É..." autofocus>
            <button onclick="sendQuestion()">üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button onclick="clearChat()" class="btn-clear">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ -->
        <div id="suggestions" class="suggestions">
            <button onclick="ask('vr')">üéÆ VR-–∑–æ–Ω—ã</button>
            <button onclick="ask('–±–∞—Ç—É—Ç—ã')">üèÄ –ë–∞—Ç—É—Ç–Ω—ã–π —Ü–µ–Ω—Ç—Ä</button>
            <button onclick="ask('–Ω–µ—Ä—Ñ')">üî´ –ù–µ—Ä—Ñ-–∞—Ä–µ–Ω–∞</button>
            <button onclick="ask('–∞–∫—Ü–∏–∏')">üéÅ –ê–∫—Ü–∏–∏</button>
            <button onclick="goToBooking()" style="background: #ffc107; color: #212529;">üìÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
            <button onclick="openCalculator()" class="btn-calc">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ -->
    <div id="calcModal" class="modal">
        <div class="modal-content">
            <h2>üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏</h2>
            <span class="close" onclick="closeCalculator()">&times;</span>
            <form id="calcForm">
                <label>–£—Å–ª—É–≥–∞:
                    <select id="service" onchange="updateForm()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                        <option value="birthday">üéâ –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</option>
                        <option value="graduation">üéì –í—ã–ø—É—Å–∫–Ω–æ–π</option>
                    </select>
                </label>
                <div id="dynamicForm"></div>
                <div class="result" id="result"></div>
                <!-- –ö–ù–û–ü–ö–ê –†–ê–°–°–ß–ò–¢–ê–¢–¨ -->
                <button type="button" onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
            </form>
        </div>
    </div>

    <p style="text-align: center; margin-top: 10px;">
        <a href="/bookings" style="color: #6f42c1;">üìã –í—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</a>
        | 
        <a href="/admin/login" style="color: #dc3545;">üîê –ê–¥–º–∏–Ω–∫–∞</a>
    </p>

    <script>
        const chat = document.getElementById('chat');
        const suggestions = document.getElementById('suggestions');
        const modal = document.getElementById('calcModal');

        function getGreeting() {
            const h = new Date().getHours();
            return h < 6 ? "–î–æ–±—Ä–æ–π –Ω–æ—á–∏" : h < 12 ? "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ" : h < 18 ? "–î–æ–±—Ä—ã–π –¥–µ–Ω—å" : "–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä";
        }

        function addMessage(role, text) {
            const msg = document.createElement('div');
            msg.className = `message ${role}`;
            msg.innerHTML = marked.parse(text);
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        function sendQuestion() {
            const input = document.getElementById('user-input');
            const question = input.value.trim();
            if (!question) return;

            addMessage('user', question);
            input.value = '';
            hideSuggestions();

            fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ question: question })
            })
            .then(r => r.json())
            .then(data => {
                addMessage('assistant', data.answer);
                suggestions.style.display = "flex";
            })
            .catch(() => {
                addMessage('assistant', 'üö´ –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.');
                suggestions.style.display = "flex";
            });
        }

        function ask(topic) {
            document.getElementById('user-input').value = topic;
            sendQuestion();
        }

        function goToBooking() {
            window.location.href = '/booking';
        }

        function hideSuggestions() {
            suggestions.style.display = "none";
        }

        window.onload = () => {
            addMessage('assistant', `**${getGreeting()}!**\n\n–†–∞–¥—ã –≤–∞—Å –≤–∏–¥–µ—Ç—å –≤ **FunLand**! üé™\n\n–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`);
            suggestions.style.display = "flex";
        };

        // === –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä ===
        function openCalculator() { modal.style.display = "block"; }
        function closeCalculator() { modal.style.display = "none"; }

        function updateForm() {
            const service = document.getElementById("service").value;
            const df = document.getElementById("dynamicForm");
            df.innerHTML = "";

            if (service === "birthday") {
                df.innerHTML = `
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π:
                        <input type="number" id="guests" min="5" max="30" value="10">
                    </label>
                    <label>–ü–∞–∫–µ—Ç:
                        <select id="package">
                            <option value="standard">–°—Ç–∞–Ω–¥–∞—Ä—Ç</option>
                            <option value="extreme">–≠–∫—Å—Ç—Ä–∏–º</option>
                            <option value="vr">VR-–ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ</option>
                        </select>
                    </label>
                    <label><input type="checkbox" id="anim"> –ê–Ω–∏–º–∞—Ç–æ—Ä (+1500 ‚ÇΩ)</label>
                    <label><input type="checkbox" id="cake"> –¢–æ—Ä—Ç (+2000 ‚ÇΩ)</label>
                `;
            }
        }

        function calculate() {
            const pkg = document.getElementById("package").value;
            const guests = parseInt(document.getElementById("guests").value) || 10;
            const anim = document.getElementById("anim").checked;
            const cake = document.getElementById("cake").checked;

            const base = { standard: 2500, extreme: 3500, vr: 4000 }[pkg];
            let total = base + (guests - 10) * 100;
            if (anim) total += 1500;
            if (cake) total += 2000;

            document.getElementById("result").innerHTML = `
                <strong>–ò—Ç–æ–≥–æ: ${total} ‚ÇΩ</strong>
                <button onclick="sendCalcResult(${total})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —á–∞—Ç</button>
            `;
        }

        function sendCalcResult(amount) {
            addMessage('assistant', `üßÆ –†–∞—Å—Å—á–∏—Ç–∞–Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å: **${amount} ‚ÇΩ**`);
            closeCalculator();
        }

        function clearChat() {
            chat.innerHTML = "";
            addMessage('assistant', `**${getGreeting()}!**\n\n–†–∞–¥—ã –≤–∞—Å –≤–∏–¥–µ—Ç—å –≤ **FunLand**! üé™`);
            suggestions.style.display = "flex";
        }
    </script>
</body>
</html>